# アクセスログトラッキングシステム - システム概要

## 1. プロジェクト概要

### 1.1 目的
複数のWebアプリケーションから利用される汎用アクセスログトラッキングシステムを提供する。
アクセスログの分析は別システムが担当し、本システムはトラッキング用ビーコンの生成・管理とデータ書き込み機能に特化する。

### 1.2 システム名
**Access Log Tracker (ALT)**

### 1.3 技術スタック
- **インフラ**: AWS (CloudFront, ALB, EC2, RDS Aurora PostgreSQL)
- **バックエンド**: Go + Gin Framework
- **Webサーバー**: Nginx
- **データベース**: Aurora PostgreSQL
- **フロントエンド**: Vanilla JavaScript
- **開発環境**: Docker

## 2. システム要件

### 2.1 機能要件
- トラッキング用JavaScriptビーコンの生成・管理
- アクセスログデータの書き込み
- 複数アプリケーション対応（アプリケーションID管理）
- クライアントサブID・モジュールID対応
- クローラー検出・除外機能
- クッキーレストラッキング対応
- 非同期読み込み対応
- バッチ処理による書き込み最適化

### 2.2 非機能要件
- **パフォーマンス**: 月間2000万PV対応
- **スケーラビリティ**: 2000以上のクライアントサイト対応
- **セキュリティ**: 他サイトでの干渉防止
- **軽量性**: トラッキングコード5KB以下
- **可用性**: 99.9%以上の稼働率
- **書き込み性能**: 5000 req/sec以上（Go移行による性能向上）

### 2.3 想定利用規模
- **大規模クライアント**: 月間90〜100万人的アクセス、2000万PV
- **中小規模クライアント**: 月間数千〜10万PV × 2000サイト

## 3. システム構成

### 3.1 アーキテクチャ（簡素化版）
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  クライアントサイト  │    │  CloudFront     │    │  S3 (ビーコンJS) │
│                 │────▶│  (ビーコン配信)  │────▶│  + Lambda@Edge  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                           │
                                                           ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  トラッキング     │    │  ALB            │    │  EC2            │
│  リクエスト      │────▶│  (ロードバランサー) │────▶│  Nginx + Go API │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                           │
                                                           ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  RDS            │    │  S3             │    │  CloudWatch     │
│  PostgreSQL     │◀───│  (ログ保存)      │◀───│  (監視・ログ)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 3.2 コンポーネント（簡素化版）
1. **CloudFront + S3**: トラッキングビーコンの高速配信
2. **ALB**: ロードバランシングとSSL終端
3. **EC2 + Nginx**: 軽量Webサーバーとリバースプロキシ
4. **Go + Gin**: 軽量APIサーバー（直接書き込み処理）
5. **RDS PostgreSQL**: 管理されたデータベース（直接書き込み）
6. **S3**: ログデータの長期保存
7. **CloudWatch**: 監視・ログ・アラート

### 3.3 実装構成の特徴（簡素化版）
- **ビーコン配信**: CloudFront + S3による高速配信
- **受信処理**: ALB + Nginx + Goによる軽量処理
- **直接書き込み**: Go APIからPostgreSQLへの直接書き込み
- **データ保存**: RDS PostgreSQL + S3による効率的な保存
- **コスト最適化**: シンプルな構成による低コスト
- **スケーラビリティ**: 水平スケーリング対応
- **安定性**: シンプルな構成による高安定性

## 4. データモデル

### 4.1 主要エンティティ
- **アプリケーション**: クライアントアプリケーション情報
- **アクセスログ**: 実際のアクセス記録
- **セッション**: ユーザーセッション情報

### 4.2 必須フィールド
- アプリケーションID（人間が目視で判断できない非連続的なユニークID）
- タイムスタンプ
- ユーザーエージェント
- IPアドレス

### 4.3 任意フィールド
- クライアントサブID
- モジュールID
- リファラー
- URL

## 5. セキュリティ考慮事項

### 5.1 クロスサイト干渉防止
- 名前空間の分離
- グローバル変数の最小化
- イベントリスナーの適切な管理

### 5.2 データ保護
- HTTPS通信の強制
- レート制限の実装
- 入力値検証

### 5.3 プライバシー対応
- クッキーレストラッキング
- 個人情報の最小化
- GDPR対応

## 6. パフォーマンス要件

### 6.1 レスポンス時間
- API応答: 50ms以下（Go移行による性能向上）
- ビーコン読み込み: ページ読み込みに影響しない非同期

### 6.2 スループット
- 同時接続: 10,000以上（Go移行による大幅向上）
- 書き込み処理: 5000 req/sec以上（Go移行による性能向上）

### 6.3 データベース
- 月別パーティショニング
- 適切なインデックス設計
- バッチ処理対応 