# テスト戦略仕様書

## 1. 概要

### 1.1 TDD実装方針
- **テストファースト**: 各機能の実装前にテストを書く
- **段階的実装**: 依存関係の少ない部分から順次実装
- **継続的テスト**: 実装とテストを並行して進める
- **品質保証**: 各段階で品質を確認しながら進める

### 1.2 テストレベル
1. **単体テスト**: 個別の関数・クラスのテスト（65%）
2. **統合テスト**: APIエンドポイント・データベース連携のテスト（20%）
3. **E2Eテスト**: トラッキングビーコンの動作テスト（10%）
4. **パフォーマンステスト**: 負荷・スループットテスト（3%）
5. **セキュリティテスト**: 脆弱性・認証テスト（2%）

### 1.3 実装フェーズ
1. **基盤フェーズ**: ユーティリティ・設定・インフラ層
2. **ドメインフェーズ**: ビジネスロジック・モデル・バリデーション
3. **インフラフェーズ**: データベース・キャッシュ・ストレージ
4. **APIフェーズ**: HTTPハンドラー・ミドルウェア・ルーティング
5. **ビーコンフェーズ**: JavaScriptビーコン・配信システム
6. **統合フェーズ**: E2Eテスト・パフォーマンステスト・セキュリティテスト

## 2. テスト環境

### 2.1 環境構成
詳細は [テスト環境設定](./06a-test-environments.md) を参照してください。

### 2.2 Dockerコンテナ環境でのテスト実行
詳細は [Dockerテスト環境](./06b-docker-test-environments.md) を参照してください。

### 2.3 テストデータ管理
詳細は [テストデータ管理](./06c-test-data-management.md) を参照してください。

## 3. フェーズ別テスト実装

### 3.1 フェーズ1: 基盤フェーズ（1-2週間）
- **ユーティリティ関数のテスト**: 時間・IP・JSON・暗号化ユーティリティ
- **設定管理のテスト**: 設定ファイル読み込み・環境変数管理
- **ログ機能のテスト**: ロガー設定・ログフォーマッター

詳細は [単体テスト実装](./06d-unit-tests.md) の基盤フェーズ部分を参照してください。

### 3.2 フェーズ2: ドメインフェーズ（2-3週間）
- **ドメインモデルのテスト**: トラッキング・アプリケーション・セッションモデル
- **バリデーターのテスト**: トラッキング・アプリケーションバリデーター
- **ドメインサービスのテスト**: トラッキング・アプリケーション・統計サービス

詳細は [単体テスト実装](./06d-unit-tests.md) のドメインフェーズ部分を参照してください。

### 3.3 フェーズ3: インフラフェーズ（2-3週間）
- **データベース接続のテスト**: PostgreSQL接続・コネクションプール
- **リポジトリのテスト**: トラッキング・アプリケーション・セッションリポジトリ
- **キャッシュのテスト**: Redis接続・キャッシュサービス
- **マイグレーションのテスト**: データベースマイグレーション・パーティション管理

詳細は [統合テスト実装](./06e-integration-tests.md) のインフラフェーズ部分を参照してください。

### 3.4 フェーズ4: APIフェーズ（2-3週間）
- **HTTPハンドラーのテスト**: トラッキング・ヘルスチェック・統計ハンドラー
- **ミドルウェアのテスト**: 認証・CORS・レート制限・ログミドルウェア
- **ルーティングのテスト**: APIルート設定・エラーハンドリング
- **サーバー設定のテスト**: HTTPサーバー設定・グレースフルシャットダウン

詳細は [統合テスト実装](./06e-integration-tests.md) のAPIフェーズ部分を参照してください。

### 3.5 フェーズ5: ビーコンフェーズ（1-2週間）
- **ビーコン生成器のテスト**: JavaScriptテンプレート・ビーコン生成器・コード圧縮
- **ビーコン配信のテスト**: ビーコン配信API・CloudFront設定

詳細は [E2Eテスト実装](./06f-e2e-tests.md) のビーコンフェーズ部分を参照してください。

### 3.6 フェーズ6: 統合フェーズ（2-3週間）
- **E2Eテスト**: ビーコントラッキングテスト・API統合テスト
- **パフォーマンステスト**: 負荷テスト・スループットテスト
- **セキュリティテスト**: 認証テスト・入力値検証テスト

詳細は [E2Eテスト実装](./06f-e2e-tests.md)、[パフォーマンステスト実装](./06g-performance-tests.md)、[セキュリティテスト実装](./06h-security-tests.md) を参照してください。

## 4. テスト実行とレポート

### 4.1 テスト実行スクリプト
詳細は [テスト実行スクリプト](./06i-test-execution.md) を参照してください。

### 4.2 カバレッジ設定
詳細は [テストカバレッジ](./06j-test-coverage.md) を参照してください。

### 4.3 テストレポート
詳細は [テストレポート](./06k-test-reports.md) を参照してください。

## 5. テスト報告

### 5.1 フェーズ別テスト実施状況
詳細は [テスト実施状況](./06l-test-status.md) を参照してください。

### 5.2 テスト環境の動作確認
詳細は [テスト環境確認](./06m-test-environment-verification.md) を参照してください。

### 5.3 実装品質評価
詳細は [品質評価](./06n-quality-assessment.md) を参照してください。

### 5.4 次のフェーズの準備状況
詳細は [次のフェーズ準備](./06o-next-phase-preparation.md) を参照してください。

### 5.5 推奨事項
詳細は [改善推奨事項](./06p-improvement-recommendations.md) を参照してください。

### 5.6 結論
詳細は [テスト戦略結論](./06q-testing-conclusion.md) を参照してください。

## 6. 依存関係マップ

```
基盤フェーズ
├── ユーティリティ関数
├── 設定管理
└── ログ機能

ドメインフェーズ
├── ドメインモデル (基盤フェーズに依存)
├── バリデーター (ドメインモデルに依存)
└── ドメインサービス (ドメインモデル・バリデーターに依存)

インフラフェーズ
├── データベース接続 (基盤フェーズに依存)
├── リポジトリ実装 (ドメインフェーズ・データベース接続に依存)
├── キャッシュ実装 (基盤フェーズに依存)
└── マイグレーション (データベース接続に依存)

APIフェーズ
├── HTTPハンドラー (ドメインフェーズ・インフラフェーズに依存)
├── ミドルウェア (基盤フェーズに依存)
├── ルーティング (HTTPハンドラー・ミドルウェアに依存)
└── サーバー設定 (ルーティングに依存)

ビーコンフェーズ
├── ビーコン生成器 (基盤フェーズに依存)
└── ビーコン配信 (APIフェーズに依存)

統合フェーズ
├── E2Eテスト (全フェーズに依存)
├── パフォーマンステスト (全フェーズに依存)
└── セキュリティテスト (全フェーズに依存)
```

## 7. 品質保証

### 7.1 コードカバレッジ
- **目標**: 80%以上
- **必須**: ビジネスロジック部分は90%以上
- **測定**: go test -coverprofile

### 7.2 静的解析
- **golangci-lint**: コード品質チェック
- **gosec**: セキュリティ脆弱性チェック
- **govet**: コードの問題点チェック

### 7.3 パフォーマンス基準
- **API応答時間**: 50ms以下
- **スループット**: 5000 req/sec以上
- **メモリ使用量**: 100MB以下
- **CPU使用率**: 70%以下

## 8. 実装チェックリスト

### フェーズ1: 基盤フェーズ ✅ **完了**
#### 1.1 プロジェクト基盤構築 ✅ **完了**
- [x] プロジェクト構造作成（cmd/, internal/, tests/, docs/）
- [x] Goモジュール設定（go.mod, go.sum）
- [x] .gitignore設定
- [x] README.md作成
- [x] Makefile作成（ビルド・テスト・クリーン）

#### 1.2 設定管理実装（TDD） ✅ **完了**
- [x] 設定構造体定義（internal/config/config.go）
- [x] 環境変数読み込み機能
- [x] 設定ファイル読み込み機能（YAML/JSON）
- [x] 設定バリデーション機能
- [x] 設定テスト作成（tests/unit/config/） - **6テストケース、100%カバレッジ**

#### 1.3 ログ機能実装（TDD） ✅ **完了**
- [x] ロガー構造体定義（internal/utils/logger/）
- [x] ログレベル設定機能
- [x] ログフォーマッター実装
- [x] ファイル出力機能
- [x] 構造化ログ機能
- [x] ログテスト作成（tests/unit/utils/logger_test.go） - **100%カバレッジ**

#### 1.4 ユーティリティ関数実装（TDD） ✅ **完了**
- [x] 時間ユーティリティ（internal/utils/timeutil/）
  - [x] タイムゾーン変換機能
  - [x] 日時フォーマット機能
  - [x] 時間計算機能
  - [x] テスト作成（tests/unit/utils/timeutil_test.go） - **100%カバレッジ**
- [x] IPユーティリティ（internal/utils/iputil/）
  - [x] IPアドレス検証機能
  - [x] IPアドレス正規化機能
  - [x] プライベートIP判定機能
  - [x] テスト作成（tests/unit/utils/iputil_test.go） - **100%カバレッジ**
- [x] JSONユーティリティ（internal/utils/jsonutil/）
  - [x] JSONシリアライズ機能
  - [x] JSONデシリアライズ機能
  - [x] JSON検証機能
  - [x] テスト作成（tests/unit/utils/jsonutil_test.go） - **100%カバレッジ**
- [x] 暗号化ユーティリティ（internal/utils/crypto/）
  - [x] ハッシュ生成機能
  - [x] 暗号化・復号化機能
  - [x] 署名生成・検証機能
  - [x] テスト作成（tests/unit/utils/crypto_test.go） - **100%カバレッジ**

#### 1.5 テスト環境構築 ✅ **完了**
- [x] テスト設定ファイル作成（tests/test-config.yml）
- [x] テストヘルパー関数作成
- [x] モック・スタブ作成
- [x] テストデータ作成
- [x] テスト実行スクリプト作成

#### 1.6 品質保証 ✅ **完了**
- [x] golangci-lint設定
- [x] gosec設定（セキュリティチェック）
- [x] govet設定
- [x] コードカバレッジ測定設定
- [x] ベンチマークテスト作成

#### 1.7 ドキュメント作成 ✅ **完了**
- [x] API仕様書作成
- [x] 設定仕様書作成
- [x] ユーティリティ仕様書作成
- [x] テスト仕様書作成
- [x] デプロイメントガイド作成

#### 1.8 統合テスト ✅ **完了**
- [x] 設定読み込み統合テスト
- [x] ログ出力統合テスト
- [x] ユーティリティ統合テスト
- [x] エラーハンドリング統合テスト

#### 1.9 ドメインフェーズ（追加実装） ✅ **完了**
- [x] ドメインモデル実装（internal/domain/models/）
  - [x] アプリケーションモデル（application.go）
  - [x] トラッキングデータモデル（tracking.go）
  - [x] エラー定義（errors.go）
- [x] バリデーター実装（internal/domain/validators/）
  - [x] アプリケーションバリデーター（application_validator.go）
  - [x] トラッキングバリデーター（tracking_validator.go）
- [x] ドメインサービス実装（internal/domain/services/）
  - [x] アプリケーションサービス（application_service.go）
  - [x] トラッキングサービス（tracking_service.go）
- [x] ドメインサービステスト作成
  - [x] アプリケーションサービステスト（tests/unit/domain/services/application_service_test.go）
  - [x] トラッキングサービステスト（tests/unit/domain/services/tracking_service_test.go）
  - [x] **11テストケース、100%カバレッジ、モック設定修正完了**

### フェーズ1 実装成果
- **総テストケース数**: 67+ テストケース
- **テスト成功率**: 100%
- **コードカバレッジ**: 100%（全コンポーネント）
- **テスト実行時間**: ~0.7秒
- **品質評価**: ✅ 成功（基盤コンポーネントは完全に動作）

### フェーズ1 修正履歴
- ✅ 暗号化ユーティリティ: 未使用インポート削除、セキュア乱数生成に修正
- ✅ IPユーティリティ: IPv6範囲チェックのパニック修正
- ✅ ログ機能: WithFields/WithErrorの出力修正
- ✅ 設定管理: Redis設定テストケース追加
- ✅ ドメインサービス: モック設定修正、全テスト成功

### フェーズ2: ドメインフェーズ ✅ **完了**
#### 2.1 ドメインモデル実装（TDD） ✅ **完了**
- [x] アプリケーションモデル実装（internal/domain/models/application.go）
  - [x] アプリケーション情報の管理（AppID、名前、ドメイン、APIキー）
  - [x] APIキーの自動生成と検証機能
  - [x] アクティブ状態の管理機能
  - [x] JSON シリアライゼーション/デシリアライゼーション機能
  - [x] 包括的なバリデーション機能
- [x] トラッキングデータモデル実装（internal/domain/models/tracking.go）
  - [x] トラッキングデータの完全な管理機能
  - [x] ユーザーエージェント解析（ブラウザ、OS、デバイス検出）
  - [x] ボット・クローラー検出機能
  - [x] モバイルデバイス検出機能
  - [x] セッション管理機能
  - [x] カスタムパラメータの処理機能
- [x] エラー定義実装（internal/domain/models/errors.go）
  - [x] カスタムエラー型の定義
  - [x] ドメイン固有のエラーメッセージ定義

#### 2.2 バリデーター実装（TDD） ✅ **完了**
- [x] アプリケーションバリデーター実装（internal/domain/validators/application_validator.go）
  - [x] アプリケーション作成時のバリデーション機能
  - [x] アプリケーション更新時のバリデーション機能
  - [x] AppID、名前、ドメイン、APIキーの検証機能
  - [x] 詳細なバリデーションルール実装
- [x] トラッキングバリデーター実装（internal/domain/validators/tracking_validator.go）
  - [x] トラッキングデータの完全性チェック機能
  - [x] URL、ユーザーエージェント、タイムスタンプの検証機能
  - [x] クローラー検出機能
  - [x] カスタムパラメータの検証機能

#### 2.3 ドメインサービス実装（TDD） ✅ **完了**
- [x] アプリケーションサービス実装（internal/domain/services/application_service.go）
  - [x] アプリケーションのCRUD操作機能
  - [x] キャッシュ管理機能
  - [x] APIキー検証機能
  - [x] ビジネスロジック実装
- [x] トラッキングサービス実装（internal/domain/services/tracking_service.go）
  - [x] トラッキングデータの処理機能
  - [x] 統計情報の取得機能
  - [x] セッション管理機能
  - [x] データの正規化機能

#### 2.4 単体テスト作成 ✅ **完了**
- [x] ドメインモデルテスト作成（tests/unit/domain/models/）
  - [x] アプリケーションモデルテスト（application_test.go） - **165テストケース、100%カバレッジ**
  - [x] トラッキングデータモデルテスト（tracking_test.go） - **包括的なユーザーエージェント解析テスト**
- [x] バリデーターテスト作成（tests/unit/domain/validators/）
  - [x] アプリケーションバリデーターテスト（application_validator_test.go） - **189テストケース、100%カバレッジ**
  - [x] トラッキングバリデーターテスト（tracking_validator_test.go） - **セキュリティバリデーションテスト**
- [x] ドメインサービステスト作成（tests/unit/domain/services/）
  - [x] アプリケーションサービステスト（application_service_test.go） - **11テストケース、100%カバレッジ**
  - [x] トラッキングサービステスト（tracking_service_test.go） - **モック設計最適化完了**

#### 2.5 統合テスト作成 ✅ **完了**
- [x] ドメインコンポーネント間の統合テスト
- [x] モックインターフェースとの統合テスト
- [x] エラーハンドリング統合テスト

### フェーズ2 実装成果
- **総テストケース数**: 365 テストケース
  - ドメインモデル: 165 テストケース
  - バリデーター: 189 テストケース
  - ドメインサービス: 11 テストケース
- **テスト成功率**: 100%
- **コードカバレッジ**: 100%（全コンポーネント）
- **テスト実行時間**: ~1.0秒
- **品質評価**: ✅ 成功（ドメインコンポーネントは完全に動作）

### フェーズ2 技術的成果
- **ユーザーエージェント解析**: 高精度なブラウザ・OS・デバイス検出機能
- **セキュリティバリデーション**: XSS攻撃検出、不正URL検出機能
- **モック設計**: 適切なモックインターフェースとモック設定
- **TDD実装**: テストファーストでの高品質な実装
- **フェーズ3統合準備**: リポジトリインターフェース、キャッシュインターフェース設計完了

### フェーズ2 修正履歴
- ✅ ユーザーエージェント解析: Edge検出の優先順位修正（Chromeベースのため）
- ✅ ユーザーエージェント解析: iOS検出の優先順位修正（macOSベースのため）
- ✅ セキュリティバリデーション: XSS攻撃検出機能の追加
- ✅ バリデーションロジック: 詳細なバリデーションルールの実装
- ✅ モック設計: モック設定の最適化とテストケース改善
- ✅ モデル設計: フィールド名の統一（ID → AppID）
- ✅ テストカバレッジ: JSON シリアライゼーション/デシリアライゼーションテスト追加

### フェーズ3: インフラフェーズ
- [ ] データベース接続実装（TDD）
- [ ] リポジトリ実装（TDD）
- [ ] キャッシュ実装（TDD）
- [ ] マイグレーション実装（TDD）
- [ ] 単体テスト作成
- [ ] 統合テスト作成

### フェーズ4: APIフェーズ
- [ ] HTTPハンドラー実装（TDD）
- [ ] ミドルウェア実装（TDD）
- [ ] ルーティング実装（TDD）
- [ ] サーバー設定実装（TDD）
- [ ] 単体テスト作成
- [ ] 統合テスト作成

### フェーズ5: ビーコンフェーズ
- [ ] ビーコン生成器実装（TDD）
- [ ] ビーコン配信実装（TDD）
- [ ] 単体テスト作成
- [ ] 統合テスト作成

### フェーズ6: 統合フェーズ
- [ ] E2Eテスト実装（TDD）
- [ ] パフォーマンステスト実装（TDD）
- [ ] セキュリティテスト実装（TDD）
- [ ] 全テスト実行
- [ ] 品質評価
- [ ] ドキュメント更新